# 사용자 로그 수집 기능 가이드

## 📝 개요

메이플스토리 RAG 챗봇에 사용자 상호작용 로그 수집 기능이 추가되었습니다. 이 기능을 통해 사용자의 질문과 답변, 성능 메트릭, 피드백 등을 체계적으로 수집하여 서비스 개선에 활용할 수 있습니다.

## 🎯 주요 기능

### 1. 자동 로그 수집
- **사용자 질문과 봇 응답** 자동 기록
- **응답 시간 및 성능 메트릭** 수집
- **RAG 검색 결과** (사용된 문서, 유사도 점수) 기록
- **오류 및 예외 상황** 추적

### 2. 사용자 피드백 시스템  
- 디스코드에서 이모지 반응으로 **간편한 피드백** 수집
- 👍 (도움됨) / 👎 (도움 안됨) / 🤔 (보통) 평가
- 피드백 데이터를 통한 **답변 품질 개선**

### 3. 분석 및 리포트
- **사용 통계** (총 상호작용, 고유 사용자 수)
- **성능 지표** (성공률, 평균 응답시간, 오류율)  
- **인기 질문** 분석으로 콘텐츠 개선 방향 파악

## 📊 수집되는 데이터

### 기본 정보
- `log_id`: 고유 로그 식별자
- `timestamp`: 로그 생성 시간
- `user_id`: 사용자 ID (디스코드: `discord_123456`)
- `session_id`: 대화 세션 ID
- `platform`: 플랫폼 구분 (`discord`, `api`, `web`)

### 대화 내용
- `user_message`: 사용자 질문
- `bot_response`: 봇 응답
- `response_time_ms`: 응답 시간 (밀리초)
- `status`: 처리 상태 (`success`, `error`, `timeout`)

### RAG 메타데이터
- `sources_used`: 사용된 문서들과 관련 정보
- `vector_scores`: 벡터 유사도 점수들
- `sources_count`: 검색된 문서 개수

### LLM 정보
- `model_used`: 사용된 AI 모델명
- `tokens_used`: 사용된 토큰 수

## 🚀 사용 방법

### 1. API 엔드포인트

#### 최근 로그 조회
```bash
GET /api/logs/recent?limit=50
```

#### 특정 사용자 로그 조회  
```bash
GET /api/logs/user/{user_id}?days=7
```

#### 분석 데이터 조회
```bash
GET /api/logs/analytics?days=7
```

#### 피드백 추가
```bash
POST /api/logs/feedback?log_id={log_id}&user_id={user_id}&rating=5
```

#### 오래된 로그 정리
```bash
DELETE /api/logs/cleanup?days_to_keep=30
```

### 2. 디스코드 봇 명령어

#### 관리자 전용 로그 분석 조회
```
!로그 [일수]
!logs [일수]  
!analytics [일수]
```

**예시:**
```
!로그 7        # 최근 7일간 통계
!logs 30       # 최근 30일간 통계
```

#### 자동 피드백 수집
- 봇 답변 후 자동으로 피드백 버튼 표시
- 사용자가 이모지 반응으로 평가 가능
- 피드백 완료 시 감사 메시지 표시

## 📁 파일 구조

### 로그 파일 저장 위치
```
logs/user_interactions/
├── interactions_2024-01-15.jsonl    # 일별 상호작용 로그
├── interactions_2024-01-16.jsonl
├── feedback_2024-01-15.jsonl        # 일별 피드백 로그  
└── feedback_2024-01-16.jsonl
```

### JSON Lines 형식
각 로그는 한 줄에 하나의 JSON 객체로 저장됩니다:

```json
{"log_id": "uuid", "timestamp": "2024-01-15T10:30:00", "user_id": "discord_123", "user_message": "렌 직업 정보", "bot_response": "렌은...", "response_time_ms": 1500, "status": "success"}
```

## 🔧 설정 및 관리

### 자동 정리 설정
- 기본적으로 **30일 이상** 된 로그 파일 자동 정리
- 수동 정리: `/api/logs/cleanup` 엔드포인트 호출

### 성능 최적화
- **메모리 캐시**: 최근 1000개 로그를 메모리에 보관
- **비동기 처리**: 로그 저장이 응답 속도에 영향을 주지 않음
- **파일 기반 저장**: 별도 데이터베이스 불필요

## 📈 분석 예시

### 성공적인 분석 리포트
```json
{
  "total_interactions": 1500,
  "unique_users": 250,  
  "success_rate": 0.95,
  "avg_response_time": 2.3,
  "most_common_queries": [
    "렌 직업 정보",
    "아델 스킬트리", 
    "보스 공략법"
  ],
  "error_rate": 0.05
}
```

## 🧪 테스트

### 로그 기능 테스트 실행
```bash
cd maplestory-chatbot-backend
python scripts/test_user_logs.py
```

테스트 내용:
- ✅ 로그 생성 및 저장
- 📊 로그 조회 기능
- 👤 사용자별 로그 필터링
- 📈 분석 데이터 생성  
- 💭 피드백 시스템
- 🚀 동시 처리 성능

## 🛡️ 프라이버시 및 보안

### 개인정보 보호
- **사용자 ID 암호화**: 디스코드 ID는 `discord_` 접두사와 함께 저장
- **민감 정보 제외**: 개인 식별 가능한 세부 정보는 저장하지 않음
- **로그 만료**: 설정된 기간 후 자동 삭제

### 접근 제어
- **관리자 권한**: 로그 조회는 디스코드 관리자 권한 필요
- **API 보안**: 프로덕션에서는 인증 토큰 필요 (설정 필요)

## 🚨 문제 해결

### 일반적인 문제

#### 로그가 저장되지 않는 경우
1. `logs/user_interactions/` 디렉토리 권한 확인
2. 디스크 용량 확인  
3. `aiofiles` 패키지 설치 확인

#### 피드백이 작동하지 않는 경우
1. 디스코드 봇 권한에서 "반응 추가" 권한 확인
2. API 서버 연결 상태 확인
3. 로그 파일에서 `log_id` 생성 여부 확인

#### 분석 데이터가 부정확한 경우
1. 로그 파일 형식 확인 (올바른 JSON Lines 형식)
2. 날짜 필터링 범위 확인
3. 캐시와 파일 동기화 상태 확인

## 🔄 업그레이드 및 마이그레이션

### 기존 시스템에서 업그레이드
1. 새로운 패키지 설치: `pip install aiofiles`
2. 로그 디렉토리 생성: `mkdir -p logs/user_interactions`  
3. API 서버 재시작으로 새 엔드포인트 활성화
4. 디스코드 봇 재시작으로 피드백 기능 활성화

### 데이터 마이그레이션
기존 로그 데이터가 있는 경우, 새 형식으로 변환하는 마이그레이션 스크립트 작성 권장

## 💡 활용 팁

### 1. 정기적인 분석
- **주간 리포트**: 매주 `!로그 7` 명령어로 주간 사용 현황 파악
- **월간 분석**: 매월 말 `!로그 30`으로 월간 트렌드 분석

### 2. 콘텐츠 개선
- **인기 질문 분석**으로 자주 묻는 내용의 문서 보강
- **낮은 피드백 점수** 질문 유형 파악하여 답변 품질 개선

### 3. 성능 모니터링  
- **응답 시간 추이** 모니터링으로 시스템 성능 최적화
- **오류율 증가** 시 즉시 원인 파악 및 대응

## 📞 지원

로그 수집 기능 관련 문의사항이나 개선 제안이 있으시면 GitHub Issues를 통해 연락해 주세요.

---

**📚 관련 문서**
- [DISCORD_BOT_GUIDE.md](./DISCORD_BOT_GUIDE.md) - 디스코드 봇 설정 가이드
- [README.md](./README.md) - 전체 프로젝트 개요
- [SYSTEM_PROMPT_GUIDE.md](./SYSTEM_PROMPT_GUIDE.md) - 시스템 프롬프트 설정 