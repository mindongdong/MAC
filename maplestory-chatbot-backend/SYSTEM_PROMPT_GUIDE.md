# 메이플스토리 RAG 시스템 프롬프트 가이드

## 📝 개요

이 문서는 메이플스토리 RAG 챗봇에서 새롭게 추가된 전문 시스템 프롬프트와 답변 템플릿 기능에 대한 가이드입니다.

## 🆕 새로운 기능

### 1. 전문 시스템 프롬프트
- **'메이플 가이드'** 페르소나 적용
- **20년 경험** 전문가 설정
- **상세한 답변 가이드라인** 내장
- **메이플스토리 특화** 답변 방식

### 2. 구조화된 답변 템플릿
- **일관된 답변 구조** 제공
- **제목, 내용, 팁, 마무리** 형식
- **자동 템플릿 적용**
- **향상된 사용자 경험**

## ⚙️ 설정 방법

### 환경 변수 설정

`.env` 파일에 다음 설정을 추가하세요:

```env
# 프롬프트 설정
USE_SYSTEM_PROMPT=true  # 새로운 시스템 프롬프트 사용
ENABLE_ANSWER_TEMPLATE=true  # 답변 템플릿 사용
```

### 설정 옵션

| 변수명 | 기본값 | 설명 |
|--------|--------|------|
| `USE_SYSTEM_PROMPT` | `true` | 전문 시스템 프롬프트 사용 여부 |
| `ENABLE_ANSWER_TEMPLATE` | `true` | 구조화된 답변 템플릿 사용 여부 |

## 🎯 시스템 프롬프트 특징

### 역할과 목표
1. **정확하고 최신**의 메이플스토리 정보 제공
2. **유저 수준별** 맞춤형 가이드 제공
3. **복잡한 시스템**을 쉽게 설명
4. **효율적인 육성 방법** 제안

### 답변 원칙
1. **정확성**: 검증된 정보만 제공
2. **구체성**: 수치, 레벨, 아이템명 등 포함
3. **실용성**: 실제 적용 가능한 조언
4. **친근함**: 딱딱하지 않은 톤 유지
5. **간결함**: 핵심 내용 중심 전달

### 전문 분야
- 캐릭터 육성 (레벨링, 스킬빌드)
- 보스 공략 (주간/월간 보스)
- 이벤트 정보
- 서버 정보 (일반/챌린저스)
- 직업 추천 및 특징
- 효율적인 재화 파밍

## 📋 답변 템플릿 구조

### 기본 템플릿

```markdown
## {제목}

{구조화된 내용}

{추가 팁}

{마무리 문구}
```

### 포맷팅 규칙
- **제목**: `##` 또는 `###` 사용
- **강조**: `**볼드**` 사용
- **목록**: 번호 (1,2,3) 또는 불릿 (•) 사용
- **이모지**: 적절히 사용 (🔥, 💡, ⚠️, 📌 등)
- **표**: 필요시 마크다운 테이블 사용

### 답변 길이 가이드
- **간단한 질문**: 3-5문장
- **일반 질문**: 1-2단락
- **복잡한 가이드**: 구조화된 목록
- **최대 제한**: 2000자 (디스코드 제한 고려)

## 🔧 사용 예시

### 코드에서 설정 확인

```python
from app.config.settings import settings

# 현재 설정 확인
print(f"시스템 프롬프트 사용: {settings.use_system_prompt}")
print(f"답변 템플릿 사용: {settings.enable_answer_template}")
```

### 동적 설정 변경

```python
# 런타임에 설정 변경 (테스트용)
settings.use_system_prompt = False  # 기본 프롬프트 사용
settings.enable_answer_template = True  # 템플릿만 사용
```

## 🧪 테스트 방법

### 기본 테스트 실행

```bash
cd maplestory-chatbot-backend
python scripts/test_rag.py
```

### 시스템 프롬프트 변형 테스트

테스트 스크립트는 자동으로 다음 4가지 조합을 테스트합니다:

1. **기본 프롬프트** (시스템 프롬프트: OFF, 템플릿: OFF)
2. **새 시스템 프롬프트** (시스템 프롬프트: ON, 템플릿: OFF)
3. **기본 프롬프트 + 템플릿** (시스템 프롬프트: OFF, 템플릿: ON)
4. **새 시스템 프롬프트 + 템플릿** (시스템 프롬프트: ON, 템플릿: ON)

### 결과 확인

테스트 완료 후 `maplestory-chatbot-backend/test_results/` 디렉토리에서 상세 결과를 확인할 수 있습니다.

## 📊 성능 비교

### 기대 효과

| 기능 | 개선 사항 |
|------|-----------|
| **전문 시스템 프롬프트** | 더 정확하고 전문적인 답변 |
| **답변 템플릿** | 일관된 구조의 읽기 쉬운 답변 |
| **메타데이터 추가** | 프롬프트 사용 여부 추적 가능 |
| **설정 기반 제어** | 상황에 맞는 유연한 사용 |

### 주의사항

1. **토큰 사용량 증가**: 시스템 프롬프트로 인해 약간의 토큰 사용량 증가
2. **응답 시간**: 템플릿 처리로 인한 미미한 지연 가능성
3. **메모리 사용**: 프롬프트 크기 증가로 인한 메모리 사용량 증가

## 🛠️ 커스터마이징

### 시스템 프롬프트 수정

`app/chains/prompts.py` 파일에서 `MAPLESTORY_SYSTEM_PROMPT` 변수를 수정하여 프롬프트를 커스터마이징할 수 있습니다.

### 답변 템플릿 수정

`app/chains/prompts.py` 파일에서 `MAPLESTORY_ANSWER_TEMPLATE` 변수를 수정하여 템플릿을 변경할 수 있습니다.

### 템플릿 로직 수정

`app/services/langchain_service.py` 파일의 `_apply_answer_template` 메서드를 수정하여 템플릿 적용 로직을 변경할 수 있습니다.

## 🔍 트러블슈팅

### 자주 발생하는 문제

1. **시스템 프롬프트가 적용되지 않음**
   - `.env` 파일의 `USE_SYSTEM_PROMPT=true` 설정 확인
   - 서비스 재시작 필요

2. **템플릿이 적용되지 않음**
   - `.env` 파일의 `ENABLE_ANSWER_TEMPLATE=true` 설정 확인
   - 정규식 패턴에 맞는 답변 구조 필요

3. **토큰 제한 오류**
   - `MAX_TOKENS` 값 증가 고려
   - 답변 길이 제한 설정 검토

### 디버깅 방법

```python
# 디버깅용 로그 활성화
import logging
logging.basicConfig(level=logging.DEBUG)

# 메타데이터에서 설정 확인
response = await service.chat(message="테스트")
print(response['metadata'])
```

## 📚 추가 자료

- [메이플스토리 공식 홈페이지](https://maplestory.nexon.com/)
- [LangChain 공식 문서](https://python.langchain.com/)
- [Claude API 문서](https://docs.anthropic.com/)

---

💡 **팁**: 최상의 결과를 위해 `USE_SYSTEM_PROMPT=true`와 `ENABLE_ANSWER_TEMPLATE=true`를 함께 사용하는 것을 권장합니다! 